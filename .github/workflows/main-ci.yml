name: main-ci
run-name: "main-ci | ${{ github.ref_name }} | ${{ github.sha }}"

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve formula Python version
        id: formula-python
        run: |
          set -euo pipefail
          FORMULA_PY="$(sed -n 's/.*depends_on "python@\([0-9]\+\.[0-9]\+\)".*/\1/p' Formula/agtop.rb | head -n1)"
          if [ -z "$FORMULA_PY" ]; then
            echo "Could not resolve python@X.Y from Formula/agtop.rb" >&2
            exit 1
          fi
          echo "version=$FORMULA_PY" >> "$GITHUB_OUTPUT"

      - name: Set up Python (formula-aligned)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.formula-python.outputs.version }}

      - name: Create isolated virtualenv
        run: |
          set -euo pipefail
          python -m venv .ci-venv
          .ci-venv/bin/python -m pip install --upgrade pip

      - name: Install formula resources into venv
        run: |
          set -euo pipefail
          python - <<'PY' > /tmp/formula_requirements.txt
          from pathlib import Path
          import re

          text = Path("Formula/agtop.rb").read_text(encoding="utf-8")
          resources = re.findall(r'resource "([^"]+)" do\n\s+url "([^"]+)"', text)
          if not resources:
              raise SystemExit("No resources found in Formula/agtop.rb")

          for name, url in resources:
              filename = url.rsplit("/", 1)[-1]
              for suffix in (".tar.gz", ".zip", ".whl"):
                  if filename.endswith(suffix):
                      filename = filename[: -len(suffix)]
                      break

              match = re.match(rf"^{re.escape(name)}-(.+)$", filename)
              version = match.group(1) if match else filename.split("-")[-1]
              print(f"{name}=={version}")
          PY

          .ci-venv/bin/python -m pip install -r /tmp/formula_requirements.txt

      - name: Install project
        run: |
          set -euo pipefail
          .ci-venv/bin/python -m pip install -e .

      - name: Verify formula resources match runtime dependency resolution
        run: |
          set -euo pipefail
          python -m venv .drift-venv
          .drift-venv/bin/python -m pip install --upgrade pip
          .drift-venv/bin/python -m pip install -e .

          .drift-venv/bin/python - <<'PY'
          import json
          import re
          import subprocess
          import sys
          from pathlib import Path

          FORMULA_PATH = Path("Formula/agtop.rb")
          EXCLUDED = {"agtop", "pip", "setuptools", "wheel"}


          def normalize_name(name):
              return re.sub(r"[-_.]+", "-", name).lower()


          def parse_formula_resources():
              text = FORMULA_PATH.read_text(encoding="utf-8")
              resources = re.findall(r'resource "([^"]+)" do\n\s+url "([^"]+)"', text)
              if not resources:
                  raise SystemExit("No resources found in Formula/agtop.rb")

              resolved = {}
              for raw_name, url in resources:
                  resource_name = normalize_name(raw_name)
                  filename = url.rsplit("/", 1)[-1]
                  for suffix in (".tar.gz", ".zip", ".whl"):
                      if filename.endswith(suffix):
                          filename = filename[: -len(suffix)]
                          break

                  match = re.match(rf"^{re.escape(raw_name)}-(.+)$", filename, re.IGNORECASE)
                  version = match.group(1) if match else filename.rsplit("-", 1)[-1]
                  resolved[resource_name] = version
              return resolved


          def parse_runtime_dependencies():
              payload = subprocess.check_output(
                  [sys.executable, "-m", "pip", "list", "--format=json"],
                  text=True,
              )
              installed = {
                  normalize_name(item["name"]): item["version"]
                  for item in json.loads(payload)
              }
              return {name: version for name, version in installed.items() if name not in EXCLUDED}


          formula = parse_formula_resources()
          runtime = parse_runtime_dependencies()

          missing_in_formula = sorted(name for name in runtime if name not in formula)
          extra_in_formula = sorted(name for name in formula if name not in runtime)
          version_mismatch = sorted(
              (name, formula[name], runtime[name])
              for name in formula
              if name in runtime and formula[name] != runtime[name]
          )

          if missing_in_formula or extra_in_formula or version_mismatch:
              print("Formula resource drift detected:")
              if missing_in_formula:
                  print("  Missing resources:", ", ".join(missing_in_formula))
              if extra_in_formula:
                  print("  Extra resources:", ", ".join(extra_in_formula))
              if version_mismatch:
                  print("  Version mismatches:")
                  for name, formula_version, runtime_version in version_mismatch:
                      print(f"    {name}: formula={formula_version}, runtime={runtime_version}")
              raise SystemExit(1)

          print("Formula resources are in sync with runtime dependencies.")
          PY

          rm -rf .drift-venv

      - name: Install dev tools
        run: |
          set -euo pipefail
          .ci-venv/bin/python -m pip install ruff pytest

      - name: Lint, format check, and tests
        run: |
          set -euo pipefail
          .ci-venv/bin/python -m ruff check .
          .ci-venv/bin/python -m ruff format --check .
          .ci-venv/bin/python -m agtop.agtop --help
          .ci-venv/bin/pytest -q
