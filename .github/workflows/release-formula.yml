name: release-formula
run-name: "release-formula | ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }} | ${{ github.sha }}"

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag to sync (for example: v0.1.8)"
        required: true
        type: string
      refresh_resources:
        description: "Regenerate Formula/agtop.rb Python resources from release tarball"
        required: true
        default: true
        type: boolean

permissions:
  contents: write

concurrency:
  group: formula-sync-main
  cancel-in-progress: false

jobs:
  sync-formula:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Resolve formula Python version
        id: formula-python
        run: |
          set -euo pipefail
          FORMULA_PY="$(sed -n 's/.*depends_on "python@\([0-9]\+\.[0-9]\+\)".*/\1/p' Formula/agtop.rb | head -n1)"
          if [ -z "$FORMULA_PY" ]; then
            echo "Could not resolve python@X.Y from Formula/agtop.rb" >&2
            exit 1
          fi
          echo "version=$FORMULA_PY" >> "$GITHUB_OUTPUT"

      - name: Set up Python (formula-aligned)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.formula-python.outputs.version }}

      - name: Validate tag and pyproject.toml version from tag commit
        env:
          TAG_NAME: ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}
        run: |
          set -euo pipefail
          VERSION="${TAG_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$TAG_NAME" ]; then
            echo "Invalid release tag: $TAG_NAME" >&2
            exit 1
          fi

          TAG_PYPROJECT="$(git show "${TAG_NAME}:pyproject.toml" 2>/dev/null || true)"
          if [ -z "$TAG_PYPROJECT" ]; then
            echo "Could not read pyproject.toml from tag ${TAG_NAME}" >&2
            exit 1
          fi

          PROJECT_VERSION="$(
            printf '%s\n' "$TAG_PYPROJECT" | awk '
              /^\[project\]/ { in_project=1; next }
              /^\[/ && in_project { in_project=0 }
              in_project && $1 == "version" {
                gsub(/"/, "", $3)
                print $3
                exit
              }
            '
          )"
          if [ -z "$PROJECT_VERSION" ]; then
            echo "Could not find [project].version in pyproject.toml at ${TAG_NAME}" >&2
            exit 1
          fi

          if [ "$PROJECT_VERSION" != "$VERSION" ]; then
            echo "Tag version ($VERSION) does not match pyproject.toml version ($PROJECT_VERSION)" >&2
            exit 1
          fi

      - name: Sync formula for tag
        env:
          GH_REPO: ${{ github.repository }}
          TAG_NAME: ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}
          REFRESH_RESOURCES: ${{ github.event_name != 'workflow_dispatch' || inputs.refresh_resources }}
        run: |
          set -euo pipefail

          URL="https://github.com/${GH_REPO}/archive/refs/tags/${TAG_NAME}.tar.gz"
          SHA256="$(curl -fsSL "${URL}" | sha256sum | awk '{print $1}')"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          for attempt in 1 2 3; do
            echo "Sync attempt ${attempt}..."
            git fetch origin main
            git checkout -B main origin/main

            sed -E -i "s|^  url \".*\"$|  url \"${URL}\"|" Formula/agtop.rb
            sed -E -i "s|^  sha256 \"[0-9a-f]{64}\"$|  sha256 \"${SHA256}\"|" Formula/agtop.rb

            if [ "${REFRESH_RESOURCES}" = "true" ]; then
              rm -rf .formula-sync-venv
              python -m venv .formula-sync-venv
              .formula-sync-venv/bin/python -m pip install --upgrade pip
              .formula-sync-venv/bin/python -m pip install "${URL}"

              .formula-sync-venv/bin/python - <<'PY'
              import json
              import re
              import subprocess
              import sys
              import urllib.request
              from pathlib import Path

              FORMULA_PATH = Path("Formula/agtop.rb")
              PACKAGE_NAME = "agtop"
              EXCLUDED = {"pip", "setuptools", "wheel", PACKAGE_NAME}


              def normalize_name(name):
                  return re.sub(r"[-_.]+", "-", name).lower()


              def fetch_sdist(package_name, package_version):
                  meta_url = f"https://pypi.org/pypi/{package_name}/{package_version}/json"
                  with urllib.request.urlopen(meta_url, timeout=30) as response:
                      payload = json.load(response)

                  sdists = [item for item in payload.get("urls", []) if item.get("packagetype") == "sdist"]
                  if not sdists:
                      raise SystemExit(f"No sdist found on PyPI for {package_name}=={package_version}")

                  preferred = next(
                      (item for item in sdists if item.get("filename", "").endswith(".tar.gz")),
                      sdists[0],
                  )
                  sha256 = preferred.get("digests", {}).get("sha256")
                  if not sha256:
                      raise SystemExit(f"Missing sha256 digest for {package_name}=={package_version}")
                  return preferred["url"], sha256


              def render_resources(resource_entries):
                  lines = []
                  for resource_name, resource_url, resource_sha in resource_entries:
                      lines.extend(
                          [
                              f'  resource "{resource_name}" do',
                              f'    url "{resource_url}"',
                              f'    sha256 "{resource_sha}"',
                              "  end",
                              "",
                          ]
                      )
                  return lines[:-1] if lines else lines


              packages_raw = subprocess.check_output(
                  [sys.executable, "-m", "pip", "list", "--format=json"],
                  text=True,
              )
              installed = {
                  normalize_name(item["name"]): item["version"]
                  for item in json.loads(packages_raw)
              }
              runtime = {name: version for name, version in installed.items() if name not in EXCLUDED}
              if not runtime:
                  raise SystemExit("No runtime dependencies resolved for release tarball")

              resources = []
              for dep_name in sorted(runtime):
                  dep_version = runtime[dep_name]
                  dep_url, dep_sha = fetch_sdist(dep_name, dep_version)
                  resources.append((dep_name, dep_url, dep_sha))

              formula_lines = FORMULA_PATH.read_text(encoding="utf-8").splitlines()
              depends_on_idx = next(
                  idx for idx, line in enumerate(formula_lines) if line.strip().startswith('depends_on "python@')
              )
              install_idx = next(
                  idx for idx, line in enumerate(formula_lines) if line.strip() == "def install"
              )

              new_lines = (
                  formula_lines[: depends_on_idx + 1]
                  + [""]
                  + render_resources(resources)
                  + [""]
                  + formula_lines[install_idx:]
              )
              FORMULA_PATH.write_text("\n".join(new_lines).rstrip() + "\n", encoding="utf-8")
              PY
            else
              echo "Skipping Python resource refresh (workflow_dispatch refresh_resources=false)."
            fi

            if git diff --quiet -- Formula/agtop.rb; then
              echo "Formula already up to date for ${TAG_NAME}."
              exit 0
            fi

            git add Formula/agtop.rb
            git commit -m "Formula/agtop: sync ${TAG_NAME} [skip ci]"

            if git push origin HEAD:main; then
              echo "Formula sync pushed successfully."
              exit 0
            fi

            echo "Push failed due to concurrent main updates; retrying..."
          done

          echo "Failed to sync formula after retries." >&2
          exit 1
