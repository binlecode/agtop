name: release-formula
run-name: "release-formula | ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }} | ${{ github.sha }}"

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag to sync (for example: v0.1.8)"
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: formula-sync-main
  cancel-in-progress: false

jobs:
  sync-formula:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Validate tag and pyproject.toml version from tag commit
        env:
          TAG_NAME: ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}
        run: |
          set -euo pipefail
          VERSION="${TAG_NAME#v}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "$TAG_NAME" ]; then
            echo "Invalid release tag: $TAG_NAME" >&2
            exit 1
          fi

          TAG_PYPROJECT="$(git show "${TAG_NAME}:pyproject.toml" 2>/dev/null || true)"
          if [ -z "$TAG_PYPROJECT" ]; then
            echo "Could not read pyproject.toml from tag ${TAG_NAME}" >&2
            exit 1
          fi

          PROJECT_VERSION="$(
            printf '%s\n' "$TAG_PYPROJECT" | awk '
              /^\[project\]/ { in_project=1; next }
              /^\[/ && in_project { in_project=0 }
              in_project && $1 == "version" {
                gsub(/"/, "", $3)
                print $3
                exit
              }
            '
          )"
          if [ -z "$PROJECT_VERSION" ]; then
            echo "Could not find [project].version in pyproject.toml at ${TAG_NAME}" >&2
            exit 1
          fi

          if [ "$PROJECT_VERSION" != "$VERSION" ]; then
            echo "Tag version ($VERSION) does not match pyproject.toml version ($PROJECT_VERSION)" >&2
            exit 1
          fi

      - name: Sync formula for tag
        env:
          GH_REPO: ${{ github.repository }}
          TAG_NAME: ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}
        run: |
          set -euo pipefail

          URL="https://github.com/${GH_REPO}/archive/refs/tags/${TAG_NAME}.tar.gz"
          SHA256="$(curl -fsSL "${URL}" | sha256sum | awk '{print $1}')"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          for attempt in 1 2 3; do
            echo "Sync attempt ${attempt}..."
            git fetch origin main
            git checkout -B main origin/main

            sed -E -i "s|^  url \".*\"$|  url \"${URL}\"|" Formula/agtop.rb
            sed -E -i "s|^  sha256 \"[0-9a-f]{64}\"$|  sha256 \"${SHA256}\"|" Formula/agtop.rb

            if git diff --quiet -- Formula/agtop.rb; then
              echo "Formula already up to date for ${TAG_NAME}."
              exit 0
            fi

            git add Formula/agtop.rb
            git commit -m "Formula/agtop: sync ${TAG_NAME} [skip ci]"

            if git push origin HEAD:main; then
              echo "Formula sync pushed successfully."
              exit 0
            fi

            echo "Push failed due to concurrent main updates; retrying..."
          done

          echo "Failed to sync formula after retries." >&2
          exit 1
