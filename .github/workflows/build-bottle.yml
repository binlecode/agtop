name: build-bottle
run-name: "build-bottle | ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.event.workflow_run.head_branch }} | ${{ github.sha }}"

on:
  workflow_run:
    workflows: ["release-formula"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag to build bottles for (e.g. v0.3.4)"
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: build-bottle-main
  cancel-in-progress: false

jobs:
  # Creates the GitHub Release if it does not already exist, and exports the
  # resolved tag name as a job output for downstream jobs.
  create-release:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.tag.outputs.name }}

    steps:
      - name: Resolve tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "name=${{ inputs.tag_name }}" >> "$GITHUB_OUTPUT"
          else
            # For workflow_run triggered by a tag push, head_branch is the tag name.
            echo "name=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release (if not already exists)
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: ${{ steps.tag.outputs.name }}
        run: |
          gh release create "${TAG_NAME}" \
            --title "${TAG_NAME}" \
            --generate-notes \
            --repo "${{ github.repository }}" 2>/dev/null \
            || echo "Release ${TAG_NAME} already exists â€” skipping create."

  # Builds one bottle per macOS platform and uploads it to the GitHub Release.
  build:
    needs: create-release
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: macos-15
            platform: arm64_sequoia
          - runner: macos-14
            platform: arm64_sonoma
          - runner: macos-26
            platform: arm64_tahoe

    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Tap formula
        run: brew tap binlecode/agtop https://github.com/binlecode/agtop

      - name: Install formula from source (build-bottle mode)
        run: brew install --build-bottle binlecode/agtop/agtop

      - name: Build bottle
        env:
          TAG_NAME: ${{ needs.create-release.outputs.tag_name }}
        run: |
          brew bottle --json \
            --root-url "https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}" \
            binlecode/agtop/agtop
          echo "--- bottle files ---"
          ls -1 *.tar.gz *.json 2>/dev/null || true

      - name: Upload bottle tarball to GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: ${{ needs.create-release.outputs.tag_name }}
        run: |
          BOTTLE=$(find . -maxdepth 1 -name "agtop*.tar.gz" | head -1)
          echo "Uploading: ${BOTTLE}"
          gh release upload "${TAG_NAME}" "${BOTTLE}" --clobber --repo "${{ github.repository }}"

      - name: Upload bottle JSON as artifact
        uses: actions/upload-artifact@v4
        with:
          name: bottle-json-${{ matrix.platform }}
          path: "agtop*.json"

  # Merges both bottle JSONs into a `bottle do` block in Formula/agtop.rb and
  # commits the result to main.
  merge:
    needs: [create-release, build]
    runs-on: macos-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Download bottle JSONs
        uses: actions/download-artifact@v4
        with:
          pattern: bottle-json-*
          merge-multiple: true

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Compute formula with bottle block
        run: |
          brew tap binlecode/agtop https://github.com/binlecode/agtop
          TAP_REPO="$(brew --repository binlecode/agtop)"
          cp Formula/agtop.rb "${TAP_REPO}/Formula/agtop.rb"
          brew bottle --merge --write --no-commit agtop*.json
          cp "${TAP_REPO}/Formula/agtop.rb" /tmp/agtop_bottled.rb

      - name: Commit and push formula with bottle block
        env:
          TAG_NAME: ${{ needs.create-release.outputs.tag_name }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          for attempt in 1 2 3; do
            echo "Attempt ${attempt}..."
            git fetch origin main
            git checkout -B main origin/main
            cp /tmp/agtop_bottled.rb Formula/agtop.rb

            if git diff --quiet -- Formula/agtop.rb; then
              echo "Bottle block already up to date."
              exit 0
            fi

            git add Formula/agtop.rb
            git commit -m "Formula/agtop: add bottles for ${TAG_NAME} [skip ci]"

            if git push origin HEAD:main; then
              echo "Committed successfully."
              exit 0
            fi
            echo "Push conflict; retrying..."
          done

          echo "Failed to commit bottle block after retries." >&2
          exit 1
